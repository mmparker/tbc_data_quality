


<head>
<link rel="stylesheet" type="text/css" href="../css/tb_report.css">
</head>


```{r setup, echo= FALSE, warning= FALSE}

# Strings ain't factors
options(stringsAsFactors = FALSE)

# Load the required libraries
library(knitr)
library(xtable)
library(RODBC)
library(plyr)


# Set default chunk options
opts_chunk$set(echo = FALSE,
               results = 'asis',
               message = FALSE,
               warning = FALSE,
               error = TRUE)


# Set up default print arguments for printing tables:
# xtable() makes data.frames more suitable for display
# format() converts all of the data.frame comments to character*;
# print() writes the xtable object to HTML

# *print() for xtable throws a tantrum over Date and POSIXct variables,
# so they have to be converted to character before printing 

dfprint <- function(df, printdigits = 2) {
    print(
        xtable(format(df, 
                      na.encode = FALSE, 
                      digits = printdigits, 
                      nsmall = printdigits), 
               align = c("l", "l", rep("c", ncol(df) - 1))
        ),
        type = "html",
        include.rownames = FALSE,
        NA.string = "-")
}



# Set up the database connection
if(interactive()) { 
    plus <- odbcConnect("tbdbplus64") 
} else {
    plus <- odbcConnect("tbdbplus32")
}
    



```



# TB Clinic Data Quality Report
Updated at `r paste(Sys.time())`



## Treatment Plan/Classification Mismatch
```{r plan_class_mismatch}

# Pull open plans
plantypes <- sqlQuery(plus, "
                  
    SELECT t.person_id, c.current_class,  t.treat_plan_type, 
           t.treat_plan_date, t.plan_author, t.plan_status
    FROM Tx_Plan_View t LEFT OUTER JOIN Case_Info_View c
    ON t.person_id = c.person_id
    WHERE t.plan_status = 'Open'
        AND author_affiliation = 'Denver Metro TB Clinic'
                      
")

# Flag discordant class/plans
plantypes$discordant <- FALSE

# Any treatment plan for the uninfected
plantypes$discordant[plantypes$current_class %in% c("Class 0", "Class 1") &
                     plantypes$treat_plan_type %in% c("LTBI", "Active")] <- TRUE

# Active plans for LTBI+
plantypes$discordant[plantypes$current_class %in% "Class 2" &
                     plantypes$treat_plan_type %in% "Active"] <- TRUE

# LTBI and Window plans for active cases and suspects
plantypes$discordant[plantypes$current_class %in% c("Class 3", "Class 5") &
                     plantypes$treat_plan_type %in% c("LTBI", "Window")] <- TRUE


#count(plantypes, c("current_class", "treat_plan_type", "discordant"))


discordant <- subset(plantypes,
                     subset = discordant,
                     select = c("person_id", "current_class", "treat_plan_type", 
                                "treat_plan_date", "plan_author", "plan_status")
)


dfprint(arrange(discordant, current_class, treat_plan_type))



```


## Patients with 2 or More Open Treatment Plans
```{r multiplan}

# Query the open plans by person_id
open_plans <- sqlQuery(plus, "
                      
    SELECT person_id, treat_plan, treat_plan_date, plan_status
    FROM Tx_Plan_View
    WHERE plan_status = 'Open'
        AND author_affiliation = 'Denver Metro TB Clinic'
                      
")

# Identify any person with multiple plans
multiplan_ids <- open_plans$person_id[duplicated(open_plans$person_id)]
multiplans <- subset(open_plans, person_id %in% multiplan_ids)

dfprint(arrange(multiplans, person_id, treat_plan_date))


```


## Treatment Plans Open Longer Than Expected
```{r plans_open_longer}

# Query the treatment plans
long_plans <- sqlQuery(plus, "
                  
    SELECT person_id, plan_author, treat_plan_date,
           treat_plan_type, ltbi_drug,
           latest_tx, plan_status, reason_stopped
    FROM Tx_Plan_View
    WHERE author_affiliation = 'Denver Metro TB Clinic'
        AND plan_status = 'Open'
                  
")

# Convert treat_plan_date to Date
long_plans$treat_plan_date <- as.Date(long_plans$treat_plan_date)

# Calculate how long each plan has been open
long_plans$days_open <- Sys.Date() - long_plans$treat_plan_date

# Flag those that have been open too long
# Rifampin - more than 4 months
# INH - more than 9 months
# INH/Rifapentine - more than 12 weeks
# Active - more than 12 months
long_plans$open_too_long <- FALSE
long_plans$open_too_long[long_plans$ltbi_drug %in% "RIF" & 
                             long_plans$days_open > 124] <- TRUE

long_plans$open_too_long[long_plans$ltbi_drug %in% "INH" & 
                             long_plans$days_open > 279] <- TRUE

long_plans$open_too_long[long_plans$ltbi_drug %in% "INH/Rifapentine" & 
                             long_plans$days_open > 84] <- TRUE

long_plans$open_too_long[long_plans$ltbi_drug %in% "INH" & 
                             long_plans$days_open > 365] <- TRUE

open_too_long <- subset(long_plans,
                        subset = open_too_long,
                        select = c("person_id", "plan_author",
                                   "treat_plan_type", "ltbi_drug",
                                   "treat_plan_date", "latest_tx",
                                   "plan_status", "reason_stopped", "days_open"))



dfprint(arrange(open_too_long, plan_author, treat_plan_type, ltbi_drug, desc(days_open)))



```


## Treatment Plans Closed Without Reason or End Date
```{r closed_without}


# Query the treatment plans
# Every plan should have a reason stopped. They should all have a treatment ending date,
# too, but to keep this list to a reasonable length I'll only pull completed plans that are
# missing end dates.
closed_without <- sqlQuery(plus, "
                  
    SELECT person_id, plan_author, treat_plan_date,
           treat_plan, plan_status, reason_stopped,
           treat_plan_end
    FROM Tx_Plan_View
    WHERE author_affiliation = 'Denver Metro TB Clinic'
        AND plan_status = 'Closed'
        AND (reason_stopped = 'Select One'
             OR (reason_stopped = 'Course Completed'
                 AND treat_plan_end Is Null
             )
        )
    ORDER BY plan_author, treat_plan_date
                  
")


dfprint(plans)


```


## Open Treatment Plans with Reason Stopped or End Date


## Incomplete LTBI Pickups in the Past Fourteen Days
```{r missed_pickups}

# Query the missed LTBI pickups from the last fourteen days
missed_pu <- sqlQuery(plus, paste("
                                  
    SELECT t.person_id, p.last_name, p.first_name, t.treatment_date
    FROM Drug_Treatment t LEFT OUTER JOIN Person p
    ON t.person_id = p.idnumber
    WHERE dispense_type = 'Pickup'
        AND completed = ''
        AND treatment_date BETWEEN (Now() - 14) AND (Now() - 1)
    ORDER BY treatment_date",
                                  
    sep = "")
                      
)
                                  

dfprint(missed_pu)


```



## Suspects Open for More Than 90 Days
```{r overdue_suspects}

# Query the Case Info records of suspects associated with our clinic
# Ignore any with a status set before 2007
suspects <- sqlQuery(plus, "

    SELECT person_id,
           case_status,
           current_status, 
           current_status_date,
             DATE() - current_status_date AS days_since_status,
		       case_manager
    FROM Case_Info_View
    WHERE current_status = '(Class 5 ) TB Suspect'
        AND case_manager Is Not Null 
        AND agency IN ('Denver Public Health - Metro TB Clinic', 'Select One')
    ORDER BY case_manager, current_status_date
                      
")

# Convert that dt to a date
suspects$current_status_date <- as.Date(suspects$current_status_date)


# Identify suspects to close
suspects$to_close <- FALSE

# Suspects prior to 2007 can stay suspects, but should be closed
suspects$to_close[suspects$current_status_date < as.Date("2007-01-01") &
                  suspects$case_status %in% "Open"] <- TRUE

# Suspects with no status date should also be closed, if possible
suspects$to_close[is.na(suspects$current_status_date) &
                  suspects$case_status %in% "Open"] <- TRUE

# Finally, for cases after 2007, anyone suspected over 90 days should be reclassified
suspects$to_close[suspects$current_status_date >= as.Date("2007-01-01") &
                  suspects$days_since_status > 90] <- TRUE



# Subset to suspects to close, and drop the to_close column
suspects_to_close <- suspects[suspects$to_close, !names(suspects) %in% "to_close"]


dfprint(suspects_to_close)

```





## TSTs with Missing Results
```{r tsts_missing_results}

# Query TSTs either placed or read by our staff but without results
# Disregard tests placed before 2009
tsts_no_result <- sqlQuery(plus, "
                 
    SELECT person_id, date_given, date_read, tst_read_by, result
    FROM TST_View
    WHERE reader_affiliation = 'Denver Metro TB Clinic'
        AND result = 'Select One'
        AND date_given >= #2009-01-01#
    ORDER BY tst_read_by, date_given
                 
")

dfprint(tsts_no_result)


```


## QFTs with Missing Results
```{r qfts_missing_results}

# Query the DPH QFTs
qfts_no_result <- sqlQuery(plus, "
                 
    SELECT person_id, lab, collection_date, result
    FROM QFT_View
    WHERE lab = 'Denver Public Health'
        AND result = 'Select One'
                 
")

# Convert the collection date
qfts_no_result$date_collected <- as.Date(qfts_no_result$collection_date, 
                                         format = "%m/%d/%Y")


dfprint(qfts_no_result[order(qfts_no_result$date_collected), 
                       !names(qfts_no_result) %in% "collection_date"]
)


```


## CXRs Requiring Action
```{r action_cxrs}

# Query the CXRs with action required from TBdb
action_cxrs <- sqlQuery(plus, "
    
    SELECT x.cxr_id, x.person_id, x.cxr_date_taken, x.cxr_date_read,
           x.cxr_read_by, x.cxr_action_text, x.action_required
    FROM CXR_View x LEFT OUTER JOIN TB_Case c
    ON x.person_id = c.person_id
    WHERE c.agency_id = 30
        AND (x.action_required = 'Yes' OR x.action_required Is Null)
    ORDER BY x.cxr_action_text, x.cxr_date_taken
                         
")

# Convert cxr_date_taken to Date
action_cxrs$cxr_date_taken <- as.Date(action_cxrs$cxr_date_taken)

# There are a lot of CXRs with action_required = NA; we only need to address
# those in the last year
action_cxrs_recent <- subset(action_cxrs,
                             action_required %in% "Yes" |
                             (is.na(action_cxrs$action_required) & 
                              action_cxrs$cxr_date_taken >= (Sys.Date() - 365)))

dfprint(action_cxrs_recent)


```






## Encounters with No Staff Responsible






## Visits with No Location
```{r no_location}

# Query encounters with visit_location = 0 ("Select One").
# Only pull face-to-face encounters - that's eval_category = 'Clinical'
# Ignore the NAs - those are imported records that predate TBdb.
enc <- sqlQuery(plus, "
                
    SELECT person_id, eval_date, staff_responsible
    FROM Eval_View
    WHERE visit_location = 'Select One'
        AND eval_category = 'Clinical'
        AND eval_date >= #2011-01-01#
        AND staff_affiliation = 'Denver Metro TB Clinic'
    ORDER BY staff_responsible, eval_date
                
")

dfprint(enc)


```



## Addresses with No County














```{r cleanup}

# Close the database connection
odbcClose(plus)


```



